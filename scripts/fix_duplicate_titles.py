#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
중복 제목 및 Description 고유화 스크립트
"""

import os
import re
from pathlib import Path

# 카테고리별 고유 제목 템플릿
TITLE_TEMPLATES = {
    'consultation': [
        "학습 방향 설정 상담 | 맞춤형 학습 로드맵",
        "진로 탐색 상담 가이드 | 적성 발견과 진로 설계",
        "내신 관리 전략 상담 | 학년별 성적 향상법",
        "학습 습관 개선 상담 | 효율적인 공부 방법",
        "시간 관리 컨설팅 | 학습 계획 수립 전략",
        "집중력 향상 상담 | 공부 몰입도 높이기",
        "학습 동기 부여 상담 | 자기주도 학습 시작",
        "과목별 학습 전략 상담 | 과목 맞춤 공부법",
        "시험 불안 해소 상담 | 시험 전 멘탈 관리",
        "학부모 교육 상담 | 자녀 학습 지도 방법",
        "성적 향상 컨설팅 | 단기 성적 개선 전략",
        "학습 환경 조성 상담 | 최적의 공부 환경",
        "독서 습관 형성 상담 | 효과적인 독서 전략",
        "노트 필기 전략 상담 | 체계적 정리 방법",
        "복습 전략 수립 상담 | 장기 기억 학습법",
        "예습 방법 컨설팅 | 선행 학습 효율화",
        "오답노트 활용 상담 | 실수 예방 전략",
        "학습 자료 선택 상담 | 효과적인 교재 고르기",
        "온라인 학습 상담 | 원격 학습 효율화",
        "학원 선택 컨설팅 | 우리 아이 맞는 학원",
    ],
    'exam': [
        "시험 2주 전 집중 전략 | 과목별 마무리 가이드",
        "시험 1주 전 최종 점검 | 실전 모의고사 활용",
        "시험 전날 준비 가이드 | 컨디션 관리 전략",
        "시험 당일 실전 전략 | 시험장 대처 방법",
        "내신 시험 완벽 대비 | 학교별 출제 경향",
        "모의고사 전략 가이드 | 실전 감각 유지법",
        "수능 D-100 집중 전략 | 막판 스퍼트 방법",
        "중간고사 대비 전략 | 학기 중반 점검",
        "기말고사 완벽 준비 | 학기 마무리 전략",
        "서술형 시험 대비법 | 논리적 답안 작성",
        "객관식 문제 풀이 전략 | 오답 제거 기법",
        "시험 시간 관리 전략 | 효율적 문제 풀이",
        "과목별 시험 전략 | 과목 특성별 대비",
        "암기 과목 시험 준비 | 단기 암기 전략",
        "수학 시험 완벽 대비 | 유형별 풀이법",
        "영어 시험 전략 가이드 | 독해와 문법 정복",
        "국어 시험 준비법 | 문학과 비문학 분석",
        "과학 시험 대비 전략 | 개념과 실험 정리",
        "사회 시험 완벽 준비 | 암기와 이해 병행",
        "예체능 시험 가이드 | 실기와 이론 대비",
    ],
    'tutoring': [
        "1:1 과외 시작 가이드 | 첫 수업 준비 전략",
        "과외 선생님 선택법 | 우리 아이 맞는 선생님",
        "과외 효과 극대화 전략 | 학습 성과 높이기",
        "수학 1:1 과외 가이드 | 개념부터 심화까지",
        "영어 과외 완벽 활용법 | 회화부터 문법까지",
        "국어 과외 전략 가이드 | 독해력 향상 방법",
        "과학 과외 학습법 | 실험과 개념 이해",
        "사회 과외 효율화 | 암기와 논리 학습",
        "초등 과외 시작 가이드 | 기초 학습 전략",
        "중등 과외 활용법 | 내신 집중 관리",
        "고등 과외 전략 | 수능과 내신 병행",
        "온라인 과외 가이드 | 비대면 학습 효과",
        "방문 과외 준비법 | 학습 환경 조성",
        "그룹 과외 vs 개인 과외 | 선택 기준",
        "과외 비용 가이드 | 합리적 가격 책정",
        "과외 학습 계획 수립 | 목표 설정 전략",
        "과외 진도 관리법 | 효율적 커리큘럼",
        "과외 숙제 활용법 | 복습 효과 극대화",
        "과외 선생님 소통법 | 학부모 참여 전략",
        "과외 성과 측정법 | 학습 효과 평가",
    ],
    'elementary': [
        "초등 1학년 학습 가이드 | 학교 적응 전략",
        "초등 2학년 공부법 | 기초 다지기 방법",
        "초등 3학년 학습 전략 | 학습 습관 형성",
        "초등 4학년 공부 가이드 | 사고력 키우기",
        "초등 5학년 학습법 | 심화 학습 시작",
        "초등 6학년 중등 준비 | 중학교 대비 전략",
        "초등 국어 학습법 | 읽기 쓰기 완성",
        "초등 수학 완벽 가이드 | 연산부터 사고력까지",
        "초등 영어 시작 가이드 | 파닉스부터 회화까지",
        "초등 과학 학습법 | 탐구력 키우기",
        "초등 사회 공부법 | 세상 이해하기",
        "초등 독서 습관 형성 | 평생 독서가 되기",
        "초등 받아쓰기 전략 | 맞춤법 완벽 정복",
        "초등 일기 쓰기 가이드 | 글쓰기 기초",
        "초등 수학 문장제 풀이 | 문제 이해력",
        "초등 영어 단어 암기법 | 효과적 어휘 학습",
        "초등 시험 준비법 | 첫 시험 대비",
        "초등 자기주도학습 | 스스로 공부하기",
        "초등 창의력 키우기 | 사고력 확장",
        "초등 집중력 향상법 | 공부 몰입도 높이기",
    ],
    'middle': [
        "중1 첫 시험 대비 | 중학교 적응 전략",
        "중2 학습 전략 | 사춘기 극복 공부법",
        "중3 입시 준비 | 고교 진학 로드맵",
        "중등 국어 완벽 가이드 | 문학과 문법 정복",
        "중등 수학 학습법 | 개념부터 심화까지",
        "중등 영어 실력 향상 | 문법과 독해 완성",
        "중등 과학 탐구 | 실험과 이론 정리",
        "중등 사회 학습법 | 역사와 지리 정복",
        "중등 내신 관리 전략 | 학년별 대비법",
        "중등 진로 탐색 | 적성 발견하기",
        "중등 자유학년제 활용 | 진로 체험 극대화",
        "중등 독서 활동 | 생기부 관리 전략",
        "중등 봉사활동 가이드 | 의미있는 활동",
        "중등 동아리 활동 | 특기 개발하기",
        "중등 시험 전략 | 과목별 공부법",
        "중등 노트 필기법 | 체계적 정리",
        "중등 암기 전략 | 효율적 암기법",
        "중등 수행평가 대비 | 높은 점수 받기",
        "중등 온라인 수업 | 비대면 학습 전략",
        "중등 특목고 준비 | 입시 준비 가이드",
    ],
    'high': [
        "고1 내신 전략 | 고등 첫 시험 대비",
        "고2 학습 로드맵 | 진로 확정과 준비",
        "고3 수능 D-365 | 입시 최종 전략",
        "수능 국어 완벽 대비 | 화법작문문학독해",
        "수능 수학 정복 전략 | 미적분과 확률통계",
        "수능 영어 실전 가이드 | 절대평가 1등급",
        "수능 탐구 과목 전략 | 과목 선택과 학습",
        "학생부종합전형 대비 | 생기부 관리 완벽 가이드",
        "논술 전형 준비 | 논리적 글쓰기",
        "정시 전략 가이드 | 수능 점수 활용",
        "수시 전략 완벽 분석 | 전형별 대비법",
        "모의고사 활용 전략 | 실전 감각 유지",
        "고등 내신 관리법 | 학년별 전략",
        "고등 진로 설계 | 학과 선택 가이드",
        "대입 면접 준비 | 자신감있는 답변",
        "자기소개서 작성법 | 진정성 담기",
        "고등 시간 관리 | 효율적 학습 계획",
        "고등 멘탈 관리 | 입시 스트레스 대처",
        "특기자 전형 준비 | 특기 개발 전략",
        "고등 독서 활동 | 심화 독서 전략",
    ]
}

# Description 템플릿
DESC_TEMPLATES = {
    'consultation': [
        "학습 방향을 잃고 방황하시나요? 전문가의 맞춤형 학습 로드맵 컨설팅으로 명확한 목표를 설정하세요. 현재 실력 진단부터 구체적인 실행 계획까지, 우리 아이에게 딱 맞는 학습 전략을 제시합니다.",
        "진로 고민으로 힘들어하는 자녀가 걱정되시나요? 적성 검사부터 진로 탐색까지 체계적인 진로 상담으로 미래를 설계하세요. 자녀의 흥미와 적성을 고려한 맞춤형 진로 설계 전략을 제공합니다.",
        "내신 성적 관리가 어려우신가요? 학년별 특성을 고려한 맞춤형 내신 관리 전략으로 성적을 향상시키세요. 과목별 학습법부터 시험 대비 전략까지, 실전에 바로 적용 가능한 노하우를 제공합니다.",
        "올바른 학습 습관 형성이 고민이신가요? 우리 아이 성향에 맞는 효율적인 공부 방법을 찾아드립니다. 집중력 향상부터 자기주도 학습까지, 평생 가는 학습 습관을 만들어드립니다.",
        "공부 시간은 많은데 성적이 안 오르나요? 효율적인 시간 관리와 학습 계획 수립으로 같은 시간에 더 많은 학습 효과를 얻으세요. 과목별 배분부터 휴식 시간까지 최적화된 계획을 제시합니다.",
    ],
    'exam': [
        "시험 2주 전, 무엇부터 시작해야 할지 막막하신가요? 과목별 핵심 개념 정리부터 실전 문제 풀이까지 체계적인 마무리 전략을 제공합니다. 남은 시간을 최대한 효율적으로 활용하는 방법을 알려드립니다.",
        "시험 1주일 남았는데 불안하신가요? 최종 점검 체크리스트와 실전 모의고사로 완벽하게 준비하세요. 시험 직전 집중 학습법과 멘탈 관리 노하우를 함께 제공합니다.",
        "시험 전날 밤, 효과적으로 마무리하는 방법이 궁금하신가요? 핵심 요약 정리와 컨디션 관리로 최상의 상태를 만드세요. 시험 당일 아침 루틴부터 시험장 입실 전까지의 완벽 가이드를 제시합니다.",
        "시험장에서 실력 발휘가 어려우신가요? 시험 시작 전 마인드 컨트롤부터 문제 풀이 순서까지, 실전 대처 전략을 마스터하세요. 긴장 완화법과 시간 배분 노하우를 알려드립니다.",
        "학교별 내신 시험 출제 경향을 파악하고 싶으신가요? 선생님별 출제 스타일 분석과 기출 문제 활용으로 고득점을 달성하세요. 과목별 맞춤 학습법과 서술형 대비 전략을 제공합니다.",
    ],
    'tutoring': [
        "1:1 과외를 처음 시작하는데 걱정되시나요? 첫 수업 준비부터 학습 목표 설정까지, 성공적인 과외 시작을 위한 완벽 가이드를 제공합니다. 학생과 선생님 모두를 위한 실전 노하우를 알려드립니다.",
        "우리 아이에게 맞는 과외 선생님을 찾기 어려우신가요? 선생님 선택 기준부터 면접 질문 리스트까지, 최적의 매칭을 위한 체크리스트를 제공합니다. 성향별, 과목별 맞춤 선생님 찾는 법을 알려드립니다.",
        "과외 비용 대비 효과가 낮다고 느끼시나요? 학습 효과를 극대화하는 과외 활용 전략으로 투자 대비 성과를 높이세요. 숙제 관리부터 진도 점검까지, 체계적인 학습 관리 노하우를 제공합니다.",
        "수학 개념 이해가 어려운 자녀 때문에 고민이신가요? 1:1 맞춤 지도로 기초부터 심화까지 완벽하게 마스터하세요. 학년별 필수 개념부터 문제 유형별 풀이법까지 체계적으로 정리합니다.",
        "영어 실력을 종합적으로 향상시키고 싶으신가요? 회화부터 문법, 독해까지 통합 학습으로 실력을 완성하세요. 파닉스 기초부터 고급 작문까지 단계별 학습 전략을 제시합니다.",
    ],
    'elementary': [
        "초등학교 입학 후 학교 적응이 걱정되시나요? 1학년 시기에 꼭 필요한 기초 학습 습관과 학교생활 적응 전략을 알려드립니다. 한글부터 숫자까지, 즐겁게 배우는 방법을 제공합니다.",
        "초등 2학년, 본격적인 공부 시작이 막막하신가요? 기초 학력을 탄탄히 다지는 학년별 맞춤 공부법을 제시합니다. 받아쓰기부터 구구단까지, 놓치면 안 되는 필수 학습 내용을 정리합니다.",
        "초등 3학년부터 학습량이 늘어나 걱정이신가요? 올바른 학습 습관 형성이 가장 중요한 시기입니다. 예습과 복습 방법부터 노트 필기법까지, 평생 가는 공부 습관을 만들어드립니다.",
        "초등 4학년, 사고력 문제가 어려워진다고요? 단순 암기를 넘어 생각하는 힘을 키우는 학습법을 알려드립니다. 수학 문장제부터 국어 독해까지, 논리적 사고력을 향상시키는 전략을 제공합니다.",
        "초등 5학년, 심화 학습이 필요한 시기입니다. 기초를 넘어 응용력과 사고력을 키우는 학습 전략으로 중학교를 대비하세요. 과목별 심화 학습법과 자기주도 학습 습관을 형성합니다.",
    ],
    'middle': [
        "중학교 첫 시험이 두렵나요? 초등과는 다른 중등 내신 시험 준비 전략을 마스터하세요. 학교 적응부터 공부 방법까지, 성공적인 중학 생활을 위한 완벽 가이드를 제공합니다.",
        "중2 사춘기 자녀의 학습 의욕 저하가 걱정되시나요? 정서적 안정과 학습 동기를 동시에 잡는 전략을 알려드립니다. 자녀와의 소통법부터 공부 습관 유지까지 실천 가능한 방법을 제시합니다.",
        "중3, 고등학교 진학이 코앞인데 준비가 안 되셨나요? 입시 로드맵부터 고교 선택까지 체계적인 준비 전략을 제공합니다. 내신 마무리와 고등 예습을 동시에 진행하는 효율적 학습법을 알려드립니다.",
        "중등 국어, 문학과 문법 모두 잡기 어려우신가요? 작품 분석부터 문법 개념까지 완벽하게 정복하는 학습법을 제시합니다. 내신과 수능을 동시에 대비하는 통합 학습 전략을 제공합니다.",
        "중등 수학, 기초부터 심화까지 체계적으로 학습하고 싶으신가요? 개념 이해부터 문제 풀이까지 단계별 학습법을 알려드립니다. 유형별 풀이 전략과 오답 관리 노하우를 제공합니다.",
    ],
    'high': [
        "고등학교 첫 내신 시험이 불안하신가요? 중학교와는 차원이 다른 고등 내신 관리 전략을 마스터하세요. 과목별 공부법부터 시간 관리까지, 고1 성공의 핵심 전략을 제공합니다.",
        "고2, 진로를 확정하고 본격적인 입시 준비를 시작해야 할 시기입니다. 학과 선택부터 생기부 관리까지 체계적인 로드맵을 제시합니다. 내신과 수능을 균형있게 준비하는 전략을 알려드립니다.",
        "수능 1년 앞으로 다가왔는데 계획이 막막하신가요? D-365 맞춤형 학습 계획으로 목표 대학에 합격하세요. 과목별 연간 학습 로드맵과 실전 대비 전략을 제공합니다.",
        "수능 국어 1등급이 목표이신가요? 화법과 작문, 문학, 독해 영역을 모두 정복하는 완벽 학습법을 알려드립니다. 시간 관리부터 선지 분석까지, 고득점 비법을 공개합니다.",
        "수능 수학에서 원하는 등급을 받고 싶으신가요? 미적분과 확률통계를 완벽하게 마스터하는 전략을 제시합니다. 개념부터 킬러 문항까지 단계별 정복 로드맵을 제공합니다.",
    ]
}

def parse_front_matter(content):
    """Front matter 파싱"""
    if not content.startswith('---'):
        return None, content, content

    parts = content.split('---', 2)
    if len(parts) < 3:
        return None, content, content

    return parts[1].strip(), parts[2].strip(), content

def get_unique_title_desc(file_path, category):
    """파일 경로를 기반으로 고유 제목과 description 생성"""
    filename = Path(file_path).stem

    # 파일명에서 번호 추출
    number_match = re.search(r'-(\d+)$', filename)
    if not number_match:
        number_match = re.search(r'(\d+)', filename)

    if number_match:
        num = int(number_match.group(1))
    else:
        num = 1

    # 템플릿 가져오기
    if category in TITLE_TEMPLATES:
        templates = TITLE_TEMPLATES[category]
        desc_templates = DESC_TEMPLATES.get(category, [])

        # 순환하여 고유 제목 선택 (20개 템플릿을 반복 사용)
        title_idx = (num - 1) % len(templates)
        desc_idx = (num - 1) % max(len(desc_templates), 1)

        title = templates[title_idx]

        if desc_templates:
            description = desc_templates[desc_idx]
        else:
            # Description 템플릿이 없으면 제목 기반으로 생성
            description = f"{title} | 2025년 최신 교육 전략과 실전 노하우를 담은 완벽 가이드입니다. 전문가의 분석과 검증된 방법론으로 학습 목표를 달성하세요."

        # 번호가 20을 초과하면 추가 키워드 삽입하여 차별화
        if num > 20:
            cycle = ((num - 1) // 20) + 1
            extra_keywords = ["심화", "실전", "고급", "마스터", "완벽", "프리미엄", "전문가", "집중"]
            keyword = extra_keywords[(cycle - 1) % len(extra_keywords)]
            title = f"{keyword} {title}"
            description = f"{keyword} 과정 - {description}"

        return title, description

    return None, None

def fix_file(file_path):
    """파일의 중복 제목/description 수정"""
    try:
        with open(file_path, 'r', encoding='utf-8') as f:
            content = f.read()

        front_matter, body, original = parse_front_matter(content)

        if not front_matter:
            return False

        # 현재 제목 추출
        title_match = re.search(r'title:\s*["\'](.+)["\']', front_matter)
        desc_match = re.search(r'description:\s*["\'](.+)["\']', front_matter, re.DOTALL)

        if not title_match:
            return False

        current_title = title_match.group(1)

        # 카테고리 판단
        rel_path = Path(file_path).relative_to(Path('content'))
        category = rel_path.parts[0] if len(rel_path.parts) > 0 else None

        # 고유 제목/description 생성
        new_title, new_desc = get_unique_title_desc(file_path, category)

        if not new_title:
            return False

        # 제목/description 교체
        modified = False
        new_front_matter = front_matter

        if new_title != current_title:
            new_front_matter = re.sub(
                r'title:\s*["\'](.+)["\']',
                f'title: "{new_title}"',
                new_front_matter
            )
            modified = True

        if new_desc and desc_match:
            current_desc = desc_match.group(1)
            if new_desc != current_desc:
                new_front_matter = re.sub(
                    r'description:\s*["\'](.+)["\']',
                    f'description: "{new_desc}"',
                    new_front_matter,
                    flags=re.DOTALL
                )
                modified = True

        if modified:
            new_content = f"---\n{new_front_matter}\n---\n{body}"

            with open(file_path, 'w', encoding='utf-8') as f:
                f.write(new_content)

            return True

        return False

    except Exception as e:
        print(f"  ❌ {file_path}: {e}")
        return False

def main():
    """메인 실행"""
    content_dir = Path('content')

    if not content_dir.exists():
        print("❌ content 디렉토리를 찾을 수 없습니다.")
        return

    # 중복 제목이 있는 카테고리만 처리
    target_dirs = [
        'consultation',
        'exam',
        'tutoring',
        'elementary',
        'middle',
        'high'
    ]

    total_fixed = 0

    for category in target_dirs:
        category_path = content_dir / category

        if not category_path.exists():
            continue

        md_files = list(category_path.glob('*.md'))
        md_files = [f for f in md_files if f.stem != '_index']

        print(f"\n📁 {category.upper()} ({len(md_files)}개 파일)")
        print("-" * 80)

        fixed_count = 0

        for md_file in sorted(md_files):
            if fix_file(md_file):
                fixed_count += 1
                print(f"  ✅ {md_file.name}")

        total_fixed += fixed_count
        print(f"수정 완료: {fixed_count}개")

    print(f"\n{'='*80}")
    print(f"✅ 중복 제목/Description 고유화 완료!")
    print(f"{'='*80}")
    print(f"총 수정된 파일: {total_fixed}개")
    print(f"{'='*80}")

if __name__ == '__main__':
    main()
