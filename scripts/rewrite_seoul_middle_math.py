#!/usr/bin/env python3
"""서울 중등 수학 콘텐츠 리라이팅 스크립트"""

import os
import re
import glob

# 표현 풀 - 서두 (30개)
INTRO_POOL = [
    "중학교 수학이 갑자기 어려워졌나요? 초등학교 때와 달라서 당황스러우실 겁니다.",
    "수학 성적이 예전 같지 않다면, 개념부터 다시 잡아야 할 때입니다.",
    "중학교 수학, 어디서부터 손을 대야 할지 막막하시죠?",
    "수학 때문에 스트레스 받는 아이, 이제 해결책을 찾아드립니다.",
    "중학교 들어와서 수학이 안 되기 시작했다면, 기초가 흔들리고 있다는 신호입니다.",
    "수학 실력, 지금 잡지 않으면 고등학교 가서 더 힘들어집니다.",
    "우리 아이 수학, 왜 갑자기 어려워졌을까요?",
    "중학 수학의 벽, 함께 넘어봅시다.",
    "수학 자신감을 되찾을 수 있습니다. 지금 시작하세요.",
    "중학교 수학, 개념만 잡으면 문제가 풀립니다.",
    "수학 포기하기엔 아직 이릅니다. 방법을 알면 달라집니다.",
    "내 아이 수학 실력, 지금 어디쯤일까요?",
    "수학 때문에 고민이라면, 혼자 끙끙대지 마세요.",
    "중학교 수학, 체계적으로 잡으면 고등학교 준비까지 됩니다.",
    "수학이 어려운 게 아니라, 배우는 방법이 안 맞았던 거예요.",
    "중학교 수학 성적, 올릴 수 있습니다.",
    "수학 기초가 탄탄해야 응용이 됩니다.",
    "우리 아이에게 맞는 수학 공부법을 찾아드립니다.",
    "수학 점수 올리고 싶으시죠? 방법이 있습니다.",
    "중학 수학, 지금 놓치면 고등학교 때 두 배로 힘들어요.",
    "수학을 싫어하는 아이도 재미있게 배울 수 있습니다.",
    "개념을 알면 수학이 쉬워집니다.",
    "중학교 수학, 막막하다면 전문가와 함께하세요.",
    "수학 실력은 하루아침에 생기지 않습니다. 꾸준함이 답입니다.",
    "내신 수학, 지금부터 준비하면 충분합니다.",
    "수학 공부, 효율적으로 하는 방법을 알려드립니다.",
    "중학생 수학, 어떻게 해야 잘할 수 있을까요?",
    "수학이 재미없다면, 배우는 방식을 바꿔야 합니다.",
    "중학교 수학, 기초부터 탄탄히 쌓아보세요.",
    "수학 성적 향상의 비결, 알려드립니다."
]

# 아이보리 박스 내용 풀 (위치별)
IVORY_BOX_POOL = {
    "진단": [
        "첫 수업에서 학생의 수학 실력을 정확하게 파악합니다. 어떤 개념이 부족한지 확인하고, 맞춤 학습 계획을 세웁니다.",
        "수업 시작 전, 현재 실력을 꼼꼼히 체크합니다. 무작정 진도를 나가지 않습니다.",
        "어디서 막히는지 먼저 알아야 합니다. 진단 후 학생에게 맞는 수업을 설계합니다.",
        "학생마다 부족한 부분이 다릅니다. 정확한 진단 후 맞춤 지도를 시작합니다.",
        "첫 시간에 개념 이해도와 문제 풀이력을 확인합니다. 이를 바탕으로 수업 방향을 정합니다.",
        "무엇을 알고 무엇을 모르는지 파악하는 것이 첫 번째입니다.",
        "레벨 테스트로 현재 위치를 확인하고, 목표까지의 로드맵을 그립니다.",
        "학생의 수학 습관과 실력을 함께 분석합니다. 효과적인 학습법을 제안합니다.",
        "진도보다 진단이 우선입니다. 학생 상태를 정확히 파악한 후 시작합니다.",
        "처음 만나면 학생의 강점과 약점을 파악합니다. 맞춤 전략을 세웁니다."
    ],
    "개념": [
        "개념을 확실히 이해해야 문제가 풀립니다. 암기가 아닌 이해 중심으로 가르칩니다.",
        "왜 그렇게 되는지 이해하면 수학이 쉬워집니다. 원리를 설명합니다.",
        "공식만 외우면 금방 까먹습니다. 원리를 이해하면 응용이 됩니다.",
        "개념 설명을 쉽게 풀어서 합니다. 이해가 되어야 문제에 적용할 수 있습니다.",
        "수학 개념은 연결되어 있습니다. 기초부터 차근차근 쌓아갑니다.",
        "어려운 개념도 쉽게 설명합니다. 학생이 이해할 때까지 반복합니다.",
        "개념 이해 없이 문제만 풀면 한계가 있습니다. 기본기를 탄탄히 합니다.",
        "왜? 라는 질문에 답할 수 있어야 진짜 이해한 겁니다.",
        "개념을 시각화하고 예시를 들어 설명합니다. 머릿속에 그림이 그려지도록.",
        "수학 개념을 일상과 연결해서 설명합니다. 친숙하게 느껴지도록 합니다."
    ],
    "문제풀이": [
        "문제 풀이 과정을 함께 점검합니다. 어디서 막히는지 정확히 찾아냅니다.",
        "다양한 유형의 문제를 풀며 실력을 키웁니다. 반복하면 익숙해집니다.",
        "틀린 문제는 왜 틀렸는지 분석합니다. 같은 실수를 반복하지 않도록.",
        "문제를 보는 눈을 길러줍니다. 무엇을 구해야 하는지 빠르게 파악하도록.",
        "풀이 과정을 논리적으로 쓰는 연습을 합니다. 서술형 대비도 됩니다.",
        "문제 해결 전략을 가르칩니다. 막막할 때 어디서부터 접근할지 알려드립니다.",
        "많이 푸는 것보다 제대로 푸는 것이 중요합니다. 질 높은 학습을 합니다.",
        "학생이 직접 풀어보게 합니다. 막히면 힌트를 주고, 스스로 해결하게 합니다.",
        "오답을 통해 배웁니다. 틀린 문제가 가장 좋은 교재입니다.",
        "실전처럼 시간을 재고 풀어봅니다. 시험 감각을 키웁니다."
    ],
    "내신": [
        "학교별 출제 경향을 분석합니다. 기출문제를 바탕으로 철저히 대비합니다.",
        "내신 시험 범위에 맞춰 집중 학습합니다. 빈출 유형을 확실히 잡습니다.",
        "서술형 평가 대비도 합니다. 풀이 과정을 깔끔하게 쓰는 연습을 합니다.",
        "학교 교과서와 프린트를 완벽 분석합니다. 시험에 나올 포인트를 잡아드립니다.",
        "내신 2주 전부터 집중 대비에 들어갑니다. 체계적으로 복습합니다.",
        "기출문제로 예상 문제를 뽑습니다. 실전 감각을 키웁니다.",
        "내신은 반복이 답입니다. 여러 번 풀어 완벽히 익힙니다.",
        "학교 선생님의 출제 스타일을 파악합니다. 맞춤 대비가 가능합니다.",
        "내신 기간에는 오로지 시험 범위에 집중합니다. 효율적으로 공부합니다.",
        "시험 직전 최종 점검을 합니다. 빈틈없이 준비합니다."
    ],
    "학년별": [
        "학년에 맞는 난이도로 수업합니다. 현재 수준에서 한 걸음씩 나아갑니다.",
        "학년별 중요 단원을 집중 공략합니다. 핵심을 놓치지 않습니다.",
        "학년이 올라갈수록 어려워집니다. 미리 대비해야 따라갈 수 있습니다.",
        "학년별 학습 로드맵을 제시합니다. 언제 무엇을 해야 할지 알려드립니다.",
        "현재 학년에 충실하면서 다음 학년을 준비합니다. 균형 잡힌 학습을 합니다.",
        "중1부터 중3까지 연결되는 개념을 체계적으로 정리합니다.",
        "학년이 바뀔 때 놓치기 쉬운 부분을 짚어드립니다.",
        "지금 학년에서 확실히 잡아야 나중이 편합니다. 기초를 단단히.",
        "학년별 필수 개념 체크리스트로 빈틈을 확인합니다.",
        "선행보다 현행이 우선입니다. 지금 배우는 것을 완벽히 합니다."
    ],
    "수업료": [
        "학생 상황에 맞춰 수업 횟수를 조절합니다. 상담 후 결정하세요.",
        "수업료는 수업 횟수와 시간에 따라 달라집니다. 자세한 내용은 상담 시 안내드립니다.",
        "효과적인 학습을 위한 적절한 수업 횟수를 권장합니다.",
        "학생의 목표와 현재 실력에 따라 최적의 수업 계획을 세웁니다.",
        "무료 상담으로 수업 방향과 비용을 안내받으세요.",
        "학습 효과를 높이는 수업 횟수를 함께 정합니다.",
        "상담에서 학생에게 맞는 수업 계획을 제안드립니다.",
        "학생별 맞춤 수업 계획을 세우고 비용을 안내합니다.",
        "수업료는 학생의 상황과 목표에 따라 유연하게 조정 가능합니다.",
        "최적의 학습 효과를 위한 수업 설계를 도와드립니다."
    ]
}

# 섹션 제목 풀
SECTION_TITLES = {
    "중학수학특징": [
        "중학교 수학이 어려운 이유",
        "중학교 수학, 무엇이 달라졌나요?",
        "초등학교와 다른 중학 수학",
        "중학교 수학이 어렵게 느껴지는 이유",
        "왜 갑자기 수학이 안 될까요?",
        "중학 수학의 특징",
        "중학교 수학, 이렇게 달라집니다",
        "수학이 어려워지는 시기",
        "중학교 수학의 벽",
        "중학 수학, 무엇이 문제일까요?",
        "중학교 수학 난이도의 비밀",
        "왜 수학 성적이 떨어질까요?",
        "중학교 수학의 진짜 어려움",
        "수학이 싫어지는 이유",
        "중학교 수학, 어디서 막히나요?"
    ],
    "학교특징": [
        "지역 학교별 수학 시험 특징",
        "내신 시험의 특징",
        "학교별 수학 출제 경향",
        "학교 시험, 이렇게 나옵니다",
        "내신 수학 시험 분석",
        "학교별 시험 난이도",
        "수학 내신, 어떻게 출제되나요?",
        "학교 시험의 특징과 대비법",
        "내신 시험 경향 분석",
        "학교별 출제 패턴",
        "수학 시험 출제 경향",
        "내신 대비 포인트",
        "학교 시험 준비 전략",
        "내신 수학의 핵심",
        "시험 출제 경향과 대비"
    ],
    "과외필요성": [
        "1:1 과외가 필요한 이유",
        "개인 맞춤 수업의 효과",
        "과외 수업의 장점",
        "왜 1:1 수업이 효과적일까요?",
        "맞춤 지도의 힘",
        "과외로 달라지는 것들",
        "1:1 수업, 무엇이 다를까요?",
        "과외의 효과",
        "맞춤 수업이 필요한 이유",
        "개인 지도의 장점",
        "1:1 과외의 효과",
        "과외 수업, 어떻게 다른가요?",
        "맞춤 학습의 힘",
        "왜 과외를 선택하나요?",
        "1:1 수업의 장점"
    ],
    "학년별전략": [
        "학년별 수학 학습 전략",
        "학년에 따른 학습법",
        "학년별 수학 공부법",
        "중1·중2·중3 학습 전략",
        "학년별 맞춤 학습",
        "학년에 맞는 수학 공부",
        "학년별 중점 사항",
        "학년별 학습 포인트",
        "학년에 따른 공부 전략",
        "중학교 학년별 수학 학습",
        "학년별 수학 로드맵",
        "학년별 학습 가이드",
        "학년에 맞는 학습법",
        "중1~중3 학습 전략",
        "학년별 공부 방향"
    ]
}

# FAQ 풀
FAQ_POOL = [
    {
        "q": "수학 기초가 부족한데 따라갈 수 있을까요?",
        "a": "학생 수준에 맞춰 시작합니다. 부족한 기초부터 차근차근 채워나갑니다."
    },
    {
        "q": "학원이랑 과외 중 뭐가 더 좋아요?",
        "a": "학생 성향에 따라 다릅니다. 맞춤 지도가 필요하면 과외가 효과적입니다."
    },
    {
        "q": "선행 학습도 해주시나요?",
        "a": "현재 학년 내용이 확실하면 선행을 진행합니다. 기초 없는 선행은 권하지 않습니다."
    },
    {
        "q": "수업은 어떤 방식으로 진행되나요?",
        "a": "개념 설명, 문제 풀이, 오답 분석 순서로 진행됩니다. 학생에 맞게 조정합니다."
    },
    {
        "q": "얼마나 해야 성적이 오르나요?",
        "a": "보통 2-3개월이면 변화가 보입니다. 꾸준히 하면 확실히 오릅니다."
    },
    {
        "q": "과외 선생님은 어떤 분인가요?",
        "a": "검증된 실력의 대학생이나 전문 강사입니다. 학생과의 소통을 중시하는 분들입니다."
    },
    {
        "q": "숙제가 많이 나오나요?",
        "a": "학생 상황에 맞게 적절히 부여합니다. 무리하지 않게 조절합니다."
    },
    {
        "q": "온라인 수업도 가능한가요?",
        "a": "가능합니다. 대면과 비슷한 효과를 냅니다."
    },
    {
        "q": "수업 시간은 어떻게 되나요?",
        "a": "보통 2시간입니다. 학생 집중력에 따라 조정 가능합니다."
    },
    {
        "q": "방학 때 수업은 어떻게 하나요?",
        "a": "방학에는 부족한 부분 보충이나 선행에 집중합니다. 횟수 조정도 가능합니다."
    }
]

# 마무리 풀
CLOSING_POOL = [
    "중학생 수학, 지금 시작하면 충분히 따라갈 수 있습니다. 함께 해요.",
    "수학 실력은 노력하면 반드시 오릅니다. 시작이 반입니다.",
    "중학교 수학, 혼자 고민하지 마세요. 도움받으면 달라집니다.",
    "수학 자신감을 되찾을 수 있습니다. 지금 상담받아보세요.",
    "내 아이 수학, 체계적으로 관리해보세요. 결과가 달라집니다.",
    "중학 수학의 기초를 탄탄히 쌓으면 고등학교도 문제없습니다.",
    "수학 때문에 스트레스 받지 마세요. 해결책이 있습니다.",
    "꾸준함이 수학 실력의 비결입니다. 함께 시작해요.",
    "수학 성적 향상, 생각보다 어렵지 않습니다.",
    "지금 시작하면 됩니다. 중학생 수학, 도와드릴게요.",
    "수학을 잘하는 방법, 알려드립니다.",
    "중학교 수학, 기초부터 탄탄히 쌓아보세요.",
    "내신 수학, 제대로 준비하면 좋은 결과가 있습니다.",
    "수학 공부, 방법을 알면 재미있어집니다.",
    "중학생 수학 실력, 지금 잡아야 합니다.",
    "수학 성적 올리고 싶다면 지금 연락주세요.",
    "중학교 수학, 함께하면 어렵지 않습니다.",
    "수학 기초, 지금 잡으면 나중이 편합니다.",
    "내 아이 수학 실력, 키워드릴게요.",
    "수학 고민, 상담으로 해결하세요.",
    "중학생 수학, 맞춤 지도로 달라집니다.",
    "수학 실력 향상의 시작점, 여기입니다.",
    "지금 시작해서 수학 자신감을 키우세요.",
    "중학교 수학, 체계적으로 잡아드립니다.",
    "수학 성적, 함께 올려봅시다.",
    "내신 수학 걱정, 이제 그만하세요.",
    "중학생 수학, 전문가와 함께하세요.",
    "수학 때문에 고민이라면 연락주세요.",
    "중학교 수학의 기초, 확실히 잡아드립니다.",
    "수학 실력, 지금부터 키워보세요."
]


def extract_info_from_file(filepath):
    """파일에서 지역 및 학교 정보 추출"""
    with open(filepath, 'r', encoding='utf-8') as f:
        content = f.read()

    # 구 이름 추출
    gu_match = re.search(r'cities:\s*\n\s*-\s*(\S+)', content)
    gu = gu_match.group(1) if gu_match else ""

    # 동 이름 추출 (title에서)
    title_match = re.search(r'title:\s*["\']?(\S+구)\s+(\S+)\s+(중등|중학)', content)
    if title_match:
        dong = title_match.group(2)
    else:
        # 파일명에서 추출
        filename = os.path.basename(filepath)
        dong_match = re.match(r'([a-z0-9]+)-middle', filename)
        dong = dong_match.group(1) if dong_match else ""

    # 학교 이름 추출
    school_match = re.search(r'title:\s*[^-]+-\s*([^"\']+)', content)
    if school_match:
        schools = school_match.group(1).strip()
    else:
        schools = ""

    # 지역 설명 추출 (첫 번째 문단에서)
    intro_match = re.search(r'---\s*\n##[^\n]+\n\n([^\n]+)', content)
    local_desc = ""
    if intro_match:
        desc = intro_match.group(1)
        # 지역 설명 부분만 추출
        if "위치" in desc or "지역" in desc or "인근" in desc:
            local_desc = desc

    return {
        "gu": gu,
        "dong": dong,
        "schools": schools,
        "local_desc": local_desc,
        "original_content": content
    }


def generate_content(info, pool_index):
    """표현 풀을 사용해 새 콘텐츠 생성"""
    gu = info["gu"]
    dong = info["dong"]
    schools = info["schools"]
    original = info["original_content"]

    # YAML 프론트매터 추출
    yaml_match = re.match(r'(---\n.*?\n---)\n', original, re.DOTALL)
    if not yaml_match:
        return None
    yaml_part = yaml_match.group(1)

    # 인덱스 기반 선택
    idx = pool_index % 30
    idx2 = (pool_index + 7) % 15
    idx3 = (pool_index + 3) % 10
    idx4 = (pool_index + 11) % 10
    idx5 = (pool_index + 5) % 10

    intro = INTRO_POOL[idx]
    section1 = SECTION_TITLES["중학수학특징"][idx2]
    section2 = SECTION_TITLES["학교특징"][(idx2 + 3) % 15]
    section3 = SECTION_TITLES["과외필요성"][(idx2 + 7) % 15]
    section4 = SECTION_TITLES["학년별전략"][(idx2 + 11) % 15]

    box1 = IVORY_BOX_POOL["진단"][idx3]
    box2 = IVORY_BOX_POOL["개념"][(idx3 + 2) % 10]
    box3 = IVORY_BOX_POOL["문제풀이"][(idx3 + 4) % 10]
    box4 = IVORY_BOX_POOL["내신"][(idx3 + 6) % 10]
    box5 = IVORY_BOX_POOL["학년별"][(idx3 + 8) % 10]
    box6 = IVORY_BOX_POOL["수업료"][idx4]

    # FAQ 선택 (4-5개)
    faq_indices = [(idx + i*2) % len(FAQ_POOL) for i in range(5)]
    selected_faqs = [FAQ_POOL[i] for i in faq_indices]

    closing = CLOSING_POOL[idx]

    # 학교 정보 문장 생성
    school_intro = ""
    if schools:
        school_intro = f"{schools} 학생들이 내신 경쟁을 하며 공부하고 있습니다."

    # 콘텐츠 생성
    content = f"""{yaml_part}

## {gu} {dong} 중학생, 수학이 어렵다면

{intro}

<div style="background-color: #FDF8F0; border-left: 3px solid #d4a574; padding: 18px; margin: 15px 0; font-size: 0.95em;">
<strong>이렇게 수업합니다!</strong><br>
{box1}
</div>

## {section1}

중학교 수학은 초등학교와 달리 추상적인 개념이 많아집니다. 문자와 식, 함수, 방정식 등 눈에 보이지 않는 것들을 다루기 시작합니다. 이 단계에서 개념을 확실히 잡지 않으면 점점 어려워집니다.

계산만 잘한다고 되는 게 아닙니다. 왜 그렇게 되는지, 어떻게 적용하는지 이해해야 합니다. 이해 없이 공식만 외우면 응용 문제에서 막힙니다.

<div style="background-color: #FDF8F0; border-left: 3px solid #d4a574; padding: 18px; margin: 15px 0; font-size: 0.95em;">
<strong>이렇게 수업합니다!</strong><br>
{box2}
</div>

## {section2}

{gu}의 중학교들은 내신 경쟁이 치열합니다. 기본 문제부터 심화 문제까지 다양하게 출제되며, 서술형 비중도 높습니다.

{school_intro} 학교별 출제 경향을 파악하고 대비하는 것이 중요합니다. 기출문제 분석을 통해 어떤 유형이 자주 나오는지 확인합니다.

<div style="background-color: #FDF8F0; border-left: 3px solid #d4a574; padding: 18px; margin: 15px 0; font-size: 0.95em;">
<strong>이렇게 수업합니다!</strong><br>
{box3}
</div>

## {section3}

학원에서는 여러 학생을 함께 가르치기 때문에 개인별 맞춤 지도가 어렵습니다. 모르는 부분이 있어도 질문하기 어렵고, 진도에 맞춰 넘어가야 합니다.

1:1 과외는 학생 수준에 맞춰 수업합니다. 모르는 부분은 확실히 짚고 넘어갑니다. 약한 부분은 더 시간을 들이고, 잘하는 부분은 빠르게 넘어갑니다.

<div style="background-color: #FDF8F0; border-left: 3px solid #d4a574; padding: 18px; margin: 15px 0; font-size: 0.95em;">
<strong>이렇게 수업합니다!</strong><br>
{box4}
</div>

## {section4}

### 중1 수학

중1은 수학적 사고의 기초를 닦는 시기입니다. 정수, 유리수 계산부터 문자와 식, 일차방정식까지 배웁니다. 이 단계에서 기초가 흔들리면 중2, 중3에서 어려워집니다.

### 중2 수학

중2는 난이도가 확 올라가는 시기입니다. 연립방정식, 일차함수, 확률 등 중요한 단원이 많습니다. 특히 일차함수는 고등학교 수학의 기초가 되므로 확실히 잡아야 합니다.

### 중3 수학

중3은 고등학교를 준비하는 시기입니다. 이차방정식, 이차함수, 삼각비, 원의 성질 등을 배웁니다. 고등학교 수학과 직접 연결되는 내용이 많아 확실히 이해하고 넘어가야 합니다.

<div style="background-color: #FDF8F0; border-left: 3px solid #d4a574; padding: 18px; margin: 15px 0; font-size: 0.95em;">
<strong>이렇게 수업합니다!</strong><br>
{box5}
</div>

## 수업료 안내

**중학생**은 주1회 22만원 - 32만원, 주2회 29만원 - 47만원 선입니다.

<div style="background-color: #FDF8F0; border-left: 3px solid #d4a574; padding: 18px; margin: 15px 0; font-size: 0.95em;">
<strong>이렇게 수업합니다!</strong><br>
{box6}
</div>

{{{{< cta-dual type="final" >}}}}

## 자주 묻는 질문

"""

    # FAQ 추가
    for faq in selected_faqs:
        content += f"""**Q. {faq['q']}**

{faq['a']}

"""

    # 마무리
    content += f"""## 마무리

{gu} {dong} 중학생 여러분, {closing}
"""

    return content


def rewrite_files():
    """서울 중등 수학 파일 리라이팅"""
    base_path = "/home/user/edu-guide/content/seoul"

    # 모든 중등 수학 파일 찾기
    files = glob.glob(f"{base_path}/**/*-middle-math.md", recursive=True)

    print(f"총 {len(files)}개 파일 발견")

    success_count = 0
    fail_count = 0

    for i, filepath in enumerate(files):
        try:
            info = extract_info_from_file(filepath)

            if not info["gu"]:
                print(f"건너뜀 (정보 추출 실패): {filepath}")
                fail_count += 1
                continue

            new_content = generate_content(info, i)

            if new_content:
                with open(filepath, 'w', encoding='utf-8') as f:
                    f.write(new_content)
                success_count += 1
                if success_count % 50 == 0:
                    print(f"진행: {success_count}/{len(files)}")
            else:
                fail_count += 1

        except Exception as e:
            print(f"오류: {filepath} - {e}")
            fail_count += 1

    print(f"\n서울 중등 수학 리라이팅 완료!")
    print(f"성공: {success_count}개, 실패: {fail_count}개")


if __name__ == "__main__":
    rewrite_files()
