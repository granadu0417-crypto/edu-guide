{{- /* HowTo Schema 생성 - 단계별 가이드가 있으면 자동 생성 */ -}}
{{- $content := .Content -}}

{{- /* 단계별 섹션 패턴 찾기 (## 1., ## 2., ## 3. 또는 ## 1단계, ## 2단계 등) */ -}}
{{- $stepPattern := `(?m)^##\s*(?:(\d+)[.\s단계]|Step\s+(\d+))[:\s]*(.+?)$` -}}
{{- $steps := findRE $stepPattern $content -}}

{{- if ge (len $steps) 2 -}}
  {{- /* 최소 2개 이상의 단계가 있어야 HowTo schema 생성 */ -}}
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "HowTo",
  "name": "{{ .Title }}",
  "description": "{{ with .Description }}{{ . }}{{ else }}{{ .Summary | truncate 200 }}{{ end }}",
  {{ with .Params.featured_image }}"image": "{{ . }}",{{ end }}
  "totalTime": "PT{{ div (countwords .Content) 200 }}M",
  "step": [
    {{- range $i, $step := $steps -}}
      {{- /* 단계 번호와 제목 추출 */ -}}
      {{- $stepNum := replaceRE `(?m)^##\s*(?:(\d+)[.\s단계]|Step\s+(\d+))[:\s]*(.+?)$` "$1$2" $step -}}
      {{- $stepName := replaceRE `(?m)^##\s*(?:\d+[.\s단계]|Step\s+\d+)[:\s]*(.+?)$` "$1" $step -}}
      {{- $stepName = trim $stepName " \n\r\t" -}}
    {
      "@type": "HowToStep",
      "position": {{ add $i 1 }},
      "name": {{ $stepName | jsonify }},
      "url": "{{ $.Permalink }}#step-{{ add $i 1 }}"
    }{{ if ne (add $i 1) (len $steps) }},{{ end }}
    {{- end -}}
  ]
}
</script>
{{- end -}}
