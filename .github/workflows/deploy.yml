name: Deploy to Cloudflare Workers KV

on:
  push:
    branches:
      - master

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Get changed content files
        id: changed
        run: |
          # ë³€ê²½ëœ content/*.md íŒŒì¼ ëª©ë¡ ì¶”ì¶œ
          CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD -- 'content/**/*.md' 2>/dev/null || echo "")

          # íŒŒì¼ ê°œìˆ˜ ì¹´ìš´íŠ¸
          if [ -z "$CHANGED_FILES" ]; then
            COUNT=0
          else
            COUNT=$(echo "$CHANGED_FILES" | wc -l)
          fi

          echo "changed_files<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGED_FILES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          echo "count=$COUNT" >> $GITHUB_OUTPUT

          echo "ğŸ“ ë³€ê²½ëœ content íŒŒì¼: $COUNTê°œ"
          if [ "$COUNT" -gt 0 ]; then
            echo "$CHANGED_FILES" | head -20
            if [ "$COUNT" -gt 20 ]; then
              echo "... ì™¸ $((COUNT - 20))ê°œ"
            fi
          fi

      - name: Check if full deploy needed
        id: deploy_type
        run: |
          # config, layouts, worker ë“±ì´ ë³€ê²½ë˜ë©´ ì „ì²´ ë°°í¬
          OTHER_CHANGES=$(git diff --name-only HEAD~1 HEAD -- 'config.toml' 'layouts/**' 'worker/**' 'static/**' 2>/dev/null || echo "")

          if [ -n "$OTHER_CHANGES" ]; then
            echo "type=full" >> $GITHUB_OUTPUT
            echo "âš¡ ì „ì²´ ë°°í¬ í•„ìš” (ì„¤ì •/í…œí”Œë¦¿ ë³€ê²½)"
          elif [ "${{ steps.changed.outputs.count }}" -gt 100 ]; then
            echo "type=full" >> $GITHUB_OUTPUT
            echo "âš¡ ì „ì²´ ë°°í¬ (ë³€ê²½ íŒŒì¼ 100ê°œ ì´ˆê³¼)"
          elif [ "${{ steps.changed.outputs.count }}" -eq 0 ]; then
            echo "type=skip" >> $GITHUB_OUTPUT
            echo "â­ï¸ ë°°í¬ ìŠ¤í‚µ (content ë³€ê²½ ì—†ìŒ)"
          else
            echo "type=incremental" >> $GITHUB_OUTPUT
            echo "ğŸš€ ì¦ë¶„ ë°°í¬ (${{ steps.changed.outputs.count }}ê°œ íŒŒì¼)"
          fi

      - name: Setup Node.js
        if: steps.deploy_type.outputs.type != 'skip'
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Wrangler
        if: steps.deploy_type.outputs.type != 'skip'
        run: npm install -g wrangler

      # ========== Worker ë°°í¬ (worker í´ë” ë³€ê²½ ì‹œ) ==========
      - name: Deploy Worker
        if: steps.deploy_type.outputs.type == 'full'
        working-directory: worker
        run: |
          echo "ğŸš€ Worker ë°°í¬ ì¤‘..."
          npx wrangler deploy
          echo "âœ… Worker ë°°í¬ ì™„ë£Œ!"
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}

      # ========== ì¦ë¶„ ë°°í¬ (ë³€ê²½ë¶„ë§Œ) ==========
      - name: Generate incremental MD KV JSON
        if: steps.deploy_type.outputs.type == 'incremental'
        working-directory: worker
        run: |
          echo "ğŸ”„ ì¦ë¶„ MD KV JSON ìƒì„± ì¤‘..."
          node generate-md-kv.js --changed "${{ steps.changed.outputs.changed_files }}"

      - name: Upload incremental KV data
        if: steps.deploy_type.outputs.type == 'incremental'
        working-directory: worker
        run: |
          if [ -s md-kv-incremental.json ] && [ "$(cat md-kv-incremental.json)" != "[]" ]; then
            echo "ğŸ“¤ ì¦ë¶„ KV ì—…ë¡œë“œ ì¤‘..."
            npx wrangler kv bulk put "md-kv-incremental.json" --namespace-id 725aefb7b1c64c6c90d2cf4daf061bf3
            echo "âœ… ì¦ë¶„ ì—…ë¡œë“œ ì™„ë£Œ!"
          else
            echo "â„¹ï¸ ì—…ë¡œë“œí•  í•­ëª© ì—†ìŒ"
          fi
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}

      # ========== ì „ì²´ ë°°í¬ ==========
      - name: Generate full MD KV JSON
        if: steps.deploy_type.outputs.type == 'full'
        working-directory: worker
        run: |
          echo "ğŸ”„ ì „ì²´ MD KV JSON ìƒì„± ì¤‘..."
          node generate-md-kv.js

      - name: Upload KV data (all batches)
        if: steps.deploy_type.outputs.type == 'full'
        working-directory: worker
        run: |
          BATCH_COUNT=$(cat batch-count.txt)
          echo "ğŸ“¤ KV ì—…ë¡œë“œ ì‹œì‘ (ì´ ${BATCH_COUNT}ê°œ ë°°ì¹˜)"

          for i in $(seq 1 $BATCH_COUNT); do
            FILE="md-kv-${i}.json"
            if [ -f "$FILE" ]; then
              echo "  ì—…ë¡œë“œ ì¤‘: $FILE"
              npx wrangler kv bulk put "$FILE" --namespace-id 725aefb7b1c64c6c90d2cf4daf061bf3
              echo "  âœ… $FILE ì™„ë£Œ"
            fi
          done

          echo "âœ… ì „ì²´ ì—…ë¡œë“œ ì™„ë£Œ!"
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}

      # ========== ì™„ë£Œ ==========
      - name: Deployment complete
        run: |
          if [ "${{ steps.deploy_type.outputs.type }}" == "skip" ]; then
            echo "â­ï¸ ë°°í¬ ìŠ¤í‚µë¨ (content ë³€ê²½ ì—†ìŒ)"
          elif [ "${{ steps.deploy_type.outputs.type }}" == "incremental" ]; then
            echo "âœ… ì¦ë¶„ ë°°í¬ ì™„ë£Œ! (${{ steps.changed.outputs.count }}ê°œ íŒŒì¼)"
          else
            echo "âœ… ì „ì²´ ë°°í¬ ì™„ë£Œ!"
          fi
          echo "ğŸŒ https://edukoreaai.com"
          echo ""
          echo "ğŸ“Š ë°°í¬ ë°©ì‹: Markdown Direct (Hugo ë¹Œë“œ ì—†ìŒ)"
          echo "â±ï¸ ì˜ˆìƒ ë°°í¬ ì‹œê°„: 1-2ë¶„"
