name: Deploy to Cloudflare Workers KV

on:
  push:
    branches:
      - master

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2  # Ïù¥Ï†Ñ Ïª§Î∞ãÍ≥º ÎπÑÍµê ÏúÑÌï¥

      - name: Get changed content files
        id: changed
        run: |
          # Î≥ÄÍ≤ΩÎêú content/*.md ÌååÏùº Î™©Î°ù Ï∂îÏ∂ú
          CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD -- 'content/**/*.md' 2>/dev/null || echo "")

          # ÌååÏùº Í∞úÏàò Ïπ¥Ïö¥Ìä∏
          if [ -z "$CHANGED_FILES" ]; then
            COUNT=0
          else
            COUNT=$(echo "$CHANGED_FILES" | wc -l)
          fi

          echo "changed_files<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGED_FILES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          echo "count=$COUNT" >> $GITHUB_OUTPUT

          echo "üìù Î≥ÄÍ≤ΩÎêú content ÌååÏùº: $COUNTÍ∞ú"
          if [ "$COUNT" -gt 0 ]; then
            echo "$CHANGED_FILES" | head -20
            if [ "$COUNT" -gt 20 ]; then
              echo "... Ïô∏ $((COUNT - 20))Í∞ú"
            fi
          fi

      - name: Check if full deploy needed
        id: deploy_type
        run: |
          # config, layouts, worker Îì±Ïù¥ Î≥ÄÍ≤ΩÎêòÎ©¥ Ï†ÑÏ≤¥ Î∞∞Ìè¨
          OTHER_CHANGES=$(git diff --name-only HEAD~1 HEAD -- 'config.toml' 'layouts/**' 'worker/**' 'static/**' 2>/dev/null || echo "")

          if [ -n "$OTHER_CHANGES" ]; then
            echo "type=full" >> $GITHUB_OUTPUT
            echo "‚ö° Ï†ÑÏ≤¥ Î∞∞Ìè¨ ÌïÑÏöî (ÏÑ§Ï†ï/ÌÖúÌîåÎ¶ø Î≥ÄÍ≤Ω)"
          elif [ "${{ steps.changed.outputs.count }}" -gt 100 ]; then
            echo "type=full" >> $GITHUB_OUTPUT
            echo "‚ö° Ï†ÑÏ≤¥ Î∞∞Ìè¨ (Î≥ÄÍ≤Ω ÌååÏùº 100Í∞ú Ï¥àÍ≥º)"
          elif [ "${{ steps.changed.outputs.count }}" -eq 0 ]; then
            echo "type=skip" >> $GITHUB_OUTPUT
            echo "‚è≠Ô∏è Î∞∞Ìè¨ Ïä§ÌÇµ (content Î≥ÄÍ≤Ω ÏóÜÏùå)"
          else
            echo "type=incremental" >> $GITHUB_OUTPUT
            echo "üöÄ Ï¶ùÎ∂Ñ Î∞∞Ìè¨ (${{ steps.changed.outputs.count }}Í∞ú ÌååÏùº)"
          fi

      - name: Setup Node.js
        if: steps.deploy_type.outputs.type != 'skip'
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup Hugo
        if: steps.deploy_type.outputs.type != 'skip'
        uses: peaceiris/actions-hugo@v3
        with:
          hugo-version: 'latest'
          extended: true

      - name: Cache Hugo modules
        if: steps.deploy_type.outputs.type != 'skip'
        uses: actions/cache@v4
        with:
          path: /tmp/hugo_cache
          key: hugo-${{ runner.os }}-${{ hashFiles('**/config.toml') }}
          restore-keys: |
            hugo-${{ runner.os }}-

      - name: Build Hugo site
        if: steps.deploy_type.outputs.type != 'skip'
        run: |
          hugo --minify
          echo "‚úÖ Hugo ÎπåÎìú ÏôÑÎ£å"

      - name: Install Wrangler
        if: steps.deploy_type.outputs.type != 'skip'
        run: npm install -g wrangler

      # ========== Ï¶ùÎ∂Ñ Î∞∞Ìè¨ (Î≥ÄÍ≤ΩÎ∂ÑÎßå) ==========
      - name: Generate incremental KV JSON
        if: steps.deploy_type.outputs.type == 'incremental'
        working-directory: worker
        run: |
          echo "üîÑ Ï¶ùÎ∂Ñ KV JSON ÏÉùÏÑ± Ï§ë..."
          node generate-incremental-kv.js "${{ steps.changed.outputs.changed_files }}"

      - name: Upload incremental KV data
        if: steps.deploy_type.outputs.type == 'incremental'
        working-directory: worker
        run: |
          if [ -s kv-incremental.json ] && [ "$(cat kv-incremental.json)" != "[]" ]; then
            echo "üì§ Ï¶ùÎ∂Ñ KV ÏóÖÎ°úÎìú Ï§ë..."
            npx wrangler kv bulk put "kv-incremental.json" --namespace-id 725aefb7b1c64c6c90d2cf4daf061bf3
            echo "‚úÖ Ï¶ùÎ∂Ñ ÏóÖÎ°úÎìú ÏôÑÎ£å!"
          else
            echo "‚ÑπÔ∏è ÏóÖÎ°úÎìúÌï† Ìï≠Î™© ÏóÜÏùå"
          fi
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}

      # ========== Ï†ÑÏ≤¥ Î∞∞Ìè¨ (100Í∞ú Ï¥àÍ≥º ÎòêÎäî ÏÑ§Ï†ï Î≥ÄÍ≤Ω) ==========
      - name: Generate full KV JSON
        if: steps.deploy_type.outputs.type == 'full'
        working-directory: worker
        run: |
          echo "üîÑ Ï†ÑÏ≤¥ KV JSON ÏÉùÏÑ± Ï§ë..."
          node generate-kv-json.js

      - name: Upload KV data batch 1
        if: steps.deploy_type.outputs.type == 'full'
        working-directory: worker
        run: npx wrangler kv bulk put "kv-data-1.json" --namespace-id 725aefb7b1c64c6c90d2cf4daf061bf3
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}

      - name: Upload KV data batch 2
        if: steps.deploy_type.outputs.type == 'full'
        working-directory: worker
        run: npx wrangler kv bulk put "kv-data-2.json" --namespace-id 725aefb7b1c64c6c90d2cf4daf061bf3
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}

      - name: Upload KV data batch 3
        if: steps.deploy_type.outputs.type == 'full'
        working-directory: worker
        run: npx wrangler kv bulk put "kv-data-3.json" --namespace-id 725aefb7b1c64c6c90d2cf4daf061bf3
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}

      - name: Upload KV data batch 4
        if: steps.deploy_type.outputs.type == 'full'
        working-directory: worker
        run: npx wrangler kv bulk put "kv-data-4.json" --namespace-id 725aefb7b1c64c6c90d2cf4daf061bf3
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}

      - name: Upload KV data batch 5
        if: steps.deploy_type.outputs.type == 'full'
        working-directory: worker
        run: npx wrangler kv bulk put "kv-data-5.json" --namespace-id 725aefb7b1c64c6c90d2cf4daf061bf3
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}

      - name: Upload KV data batch 6
        if: steps.deploy_type.outputs.type == 'full'
        working-directory: worker
        run: npx wrangler kv bulk put "kv-data-6.json" --namespace-id 725aefb7b1c64c6c90d2cf4daf061bf3
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}

      - name: Upload KV data batch 7
        if: steps.deploy_type.outputs.type == 'full'
        working-directory: worker
        run: npx wrangler kv bulk put "kv-data-7.json" --namespace-id 725aefb7b1c64c6c90d2cf4daf061bf3
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}

      - name: Upload KV data batch 8
        if: steps.deploy_type.outputs.type == 'full'
        working-directory: worker
        run: npx wrangler kv bulk put "kv-data-8.json" --namespace-id 725aefb7b1c64c6c90d2cf4daf061bf3
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}

      - name: Upload KV data batch 9
        if: steps.deploy_type.outputs.type == 'full'
        working-directory: worker
        run: npx wrangler kv bulk put "kv-data-9.json" --namespace-id 725aefb7b1c64c6c90d2cf4daf061bf3
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}

      - name: Upload KV data batch 10
        if: steps.deploy_type.outputs.type == 'full'
        working-directory: worker
        run: npx wrangler kv bulk put "kv-data-10.json" --namespace-id 725aefb7b1c64c6c90d2cf4daf061bf3
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}

      - name: Upload KV data batch 11
        if: steps.deploy_type.outputs.type == 'full'
        working-directory: worker
        run: npx wrangler kv bulk put "kv-data-11.json" --namespace-id 725aefb7b1c64c6c90d2cf4daf061bf3
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}

      - name: Upload KV data batch 12
        if: steps.deploy_type.outputs.type == 'full'
        working-directory: worker
        run: npx wrangler kv bulk put "kv-data-12.json" --namespace-id 725aefb7b1c64c6c90d2cf4daf061bf3
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}

      - name: Upload KV data batch 13
        if: steps.deploy_type.outputs.type == 'full'
        working-directory: worker
        run: npx wrangler kv bulk put "kv-data-13.json" --namespace-id 725aefb7b1c64c6c90d2cf4daf061bf3
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}

      - name: Upload KV data batch 14
        if: steps.deploy_type.outputs.type == 'full'
        working-directory: worker
        run: npx wrangler kv bulk put "kv-data-14.json" --namespace-id 725aefb7b1c64c6c90d2cf4daf061bf3
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}

      - name: Upload KV data batch 15
        if: steps.deploy_type.outputs.type == 'full'
        working-directory: worker
        run: npx wrangler kv bulk put "kv-data-15.json" --namespace-id 725aefb7b1c64c6c90d2cf4daf061bf3
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}

      # ========== ÏôÑÎ£å ==========
      - name: Deployment complete
        run: |
          if [ "${{ steps.deploy_type.outputs.type }}" == "skip" ]; then
            echo "‚è≠Ô∏è Î∞∞Ìè¨ Ïä§ÌÇµÎê® (content Î≥ÄÍ≤Ω ÏóÜÏùå)"
          elif [ "${{ steps.deploy_type.outputs.type }}" == "incremental" ]; then
            echo "‚úÖ Ï¶ùÎ∂Ñ Î∞∞Ìè¨ ÏôÑÎ£å! (${{ steps.changed.outputs.count }}Í∞ú ÌååÏùº)"
          else
            echo "‚úÖ Ï†ÑÏ≤¥ Î∞∞Ìè¨ ÏôÑÎ£å!"
          fi
          echo "üåê https://edukoreaai.com"
